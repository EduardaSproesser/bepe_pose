# Pose Estimation (`pose`)

This folder contains the full ArUco pose-estimation analysis pipeline:

1. detect marker corners in collected images,
2. estimate pose (single or multi-marker methods),
3. generate plots and aggregate error tables.

It also includes camera parameters and precomputed results.

## Folder Contents

- `find_corners.py` — detects valid ArUco markers and writes per-image CSV files.
- `estimator.py` — computes estimated poses (`rvec_est`, `tvec_est`) from detected corners.
- `graphs.py` — builds plots and summary metrics across marker/estimation configurations.
- `view_error_table.py` — quick terminal summary for `complete_error_table.csv`.
- `find_transf.py` — helper script for rigid transform / marker frame validation.
- `camera_params.npz` — camera intrinsics for omnidirectional model (`K`, `D`, `XI`).
- `complete_error_table.csv` — aggregated metrics generated by `graphs.py`.
- `results/`, `resultsd50/` — output plot folders grouped by marker + estimation type.

## Data Flow

### 1) Corner detection (`find_corners.py`)

Input expectations per image folder:

- image files (`.jpg`)
- a metadata CSV named either:
  - `photos_data.csv` (preferred), or
  - `photos.csv` (fallback)

The script:

- reads marker metadata (`marker_type`, `pose`, etc.),
- detects ArUco markers (`DICT_4X4_50`),
- keeps only IDs expected for each marker type (`1p`, `2e`, `3e`, `2v`, `3v`),
- converts printer-frame pose to camera-frame pose,
- writes a semicolon-separated CSV with columns like:
  `img_id;...;rvec;tvec;n_valid;corners;ids`.

Default script behavior currently processes subfolders under a hardcoded `main_folder` and writes CSVs into a `results/` subfolder.

### 2) Pose estimation (`estimator.py`)

`Estimator` loads camera parameters from `camera_params.npz` and estimates poses from the corners CSV.

Supported modes:

- `single`
- `multi_mean`
- `multi_iterative`

Output:

- appends `rvec_est` and `tvec_est` to a new CSV:
  `*_with_poses_<estimation_type>.csv`

Important implementation details:

- uses omnidirectional undistortion (`cv2.omnidir.undistortPoints`),
- handles marker-specific geometry and ID-based transforms,
- supports both single-marker and multi-marker strategies.

### 3) Graphs and metrics (`graphs.py`)

`graphs.py` reads multiple `*_with_poses_*.csv` files, concatenates them, and generates:

- translation/rotation error plots,
- detection-rate plots by distance/angle bins,
- 3D detection heatmaps,
- complete aggregated error table (`complete_error_table.csv`).

By default, outputs are saved under:

- `results/<marker_type>_<estimation_type>/`

It also applies a robust outlier filter (MAD-based) before most analyses.

### 4) Table inspection (`view_error_table.py`)

Reads `complete_error_table.csv` and prints:

- per-configuration summary,
- distance-bin and angle-bin summaries,
- best/worst configurations by translation, rotation, and weighted detection rate.

## Dependencies

Install required Python packages:

```bash
pip install opencv-contrib-python numpy pandas matplotlib
```

`opencv-contrib-python` is required because this code uses:

- `cv2.aruco`
- `cv2.omnidir`

## Typical Run Order

1. Generate corners CSVs:

   ```bash
   python find_corners.py
   ```

2. Generate estimated-pose CSVs:

   ```bash
   python estimator.py
   ```

3. Generate plots and error table:

   ```bash
   python graphs.py
   ```

4. Inspect table summary:

   ```bash
   python view_error_table.py
   ```

## Important Setup Notes

Paths are now configurable through environment variables:

- `BEPE_ROOT`: repository root (optional; default auto-detected)
- `BEPE_DATA_ROOT`: dataset root used by `find_corners.py`
- `BEPE_RESULTS_ROOT`: corners/results root used by `estimator.py` and `graphs.py`
- `BEPE_CAMERA_PARAMS_FILE`: custom path to camera parameters (`.npz`) for `estimator.py`
- `BEPE_OUTPUT_RESULTS_DIR`: output folder for generated plots in `graphs.py`

Example (Windows cmd):

```cmd
set BEPE_ROOT=C:\path\to\bepe_pose
set BEPE_DATA_ROOT=C:\path\to\markers\data\d100
set BEPE_RESULTS_ROOT=C:\path\to\markers\data\d100\results
set BEPE_CAMERA_PARAMS_FILE=C:\path\to\bepe_pose\pose\camera_params.npz
set BEPE_OUTPUT_RESULTS_DIR=results
```

## CSV Format Notes

- CSV separator is `;` (semicolon).
- Vector-like fields (e.g., `rvec`, `tvec`, `corners`) store comma-separated values inside each cell.
- Multi-marker corners are separated by `|` inside the `corners` and `ids` columns.
